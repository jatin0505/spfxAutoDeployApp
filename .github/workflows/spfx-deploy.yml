name: SPFx CICD

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16.x"

      - name: Install dependencies
        run: |
          npm ci
          npm i -g gulp

      - name: Bundle project
        run: gulp bundle --ship

      - name: Package solution
        run: gulp package-solution --ship

      - name: Install PNP
        shell: pwsh
        run: |
          Install-Module -Name PnP.PowerShell -AllowPrerelease -SkipPublisherCheck -AllowClobber -Scope CurrentUser -Force -AcceptLicense
      
      # Print the id of the app
      - name: Get the id of the app deployed
        run: echo "The site domain is ${{ env.SP_ENVIRONMENT.SHAREPOINTSITE }} and client id is ${{env.SP_ENVIRONMENT.secrets.APPCLIENTID}} and client secret is ${{env.SP_ENVIRONMENT.secrets.APPSECRET}}"
        
      - name: Publish to development APP catalog
        shell: pwsh
        run: |
          Connect-PnPOnline -Url "https://${{env.SP_ENVIRONMENT.SHAREPOINTSITE}}.sharepoint.com" -ClientId '${{env.SP_ENVIRONMENT.secrets.APPCLIENTID}}' -ClientSecret '${{env.SP_ENVIRONMENT.secrets.APPSECRET}}' 
          $catalogURL=Get-PnPTenantAppCatalogUrl
          Connect-PnPOnline -Url $catalogURL -ClientId '${{env.SP_ENVIRONMENT.secrets.APPCLIENTID}}' -ClientSecret '${{env.SP_ENVIRONMENT.secrets.APPSECRET}}'
          Add-PnPApp -Path ./sharepoint/solution/spfx-demo-app.sppkg -Publish -Overwrite
          Disconnect-PnPOnline
